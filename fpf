#!/usr/bin/bash

### Set up package lists
pacman -Slq | sort > /tmp/packages

### Help 
Help() {
    echo
    echo "Use fzf to search and install with Pacman and Yay"
    echo "Defaults to Pacman if no options passed"
    echo
    echo "Syntax: fpf -[y|h]"
    echo
    echo "options:"
    echo
    echo "y     Search and install with Yay"
    echo
    echo "h     Print this help screen."
    echo
    echo
}

### MAIN

#   Test for AUR option, if not run with pacman
if [[ -z "$1" ]]; then
	echo "Setting things up..."
#    echo -e "$(pacman -Qqe)\n" > /tmp/local_packages
#    counter=1
#    while IFS= read -r line; do
#    	sed -i -e '/$line/ s/.*/"$line" */g' /tmp/packages
#    	counter=$((counter+1))
#    done < /tmp/local_packages
	mapfile -t local_pkgs < <(pacman -Qqe)
	for line in "${local_pkgs[@]}"; do
		sed -i "s/${line}/${line} */" /tmp/packages
	done
	unset local_pkgs
    cat /tmp/packages |fzf -e -m --preview 'cat <(pacman -Si {1}) <(pacman -Fl {1} | awk "{print \$2}")' --layout=reverse --prompt='Select packages to install (use TAB to toggle selection) >' | xargs -ro -n1 sudo pacman -S
    clear
fi

while getopts ":yh" option; do
	case $option in
      y) #Get AUR package database, remove unwanted lines, preview database and hand off to yay for install
	    clear
        echo -e "Syncing AUR package database..." 
        wget -P /tmp/aur/ https://aur.archlinux.org/packages.gz >/dev/null 2>&1 && gunzip -f /tmp/aur/packages.gz
        echo "$(tail -n +2 /tmp/aur/packages)" > /tmp/aur/packages
        cat /tmp/aur/packages | fzf -e -m --preview  'cat <(yay -Si {1}) <(yay -Fl {1} | awk "{print \$2}")' --layout=reverse --prompt='Select packages to install (use TAB to toggle selection) >' | xargs -ro -n1 yay -S
        clear
        ;;
      h) #Usage // Help
        Help
        ;;
      *) #Error catching
        echo "Invalid Usage"
        sleep 2
        Help
        ;;
	esac
done
